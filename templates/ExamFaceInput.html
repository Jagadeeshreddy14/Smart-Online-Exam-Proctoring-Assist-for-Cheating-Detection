<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Face Input | Online Proctor</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="{{url_for('static', filename='css/style.css')}}">
  <link rel="stylesheet" href="{{url_for('static', filename='css/FaceInput.css')}}">
</head>

<body>

  <nav>
    <div class="logo">
      <span class="P-title">The Online Exam Proctor</span>
    </div>
    <div class="nav-links">
      <a class="links" href="{{ url_for('rules') }}">Rules</a>
      <a class="links" href="#">Requirements</a>
    </div>
  </nav>

  <div class="container">
    <!-- Background Orbs -->
    <div
      style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; overflow:hidden; pointer-events:none;">
      <div class="bg-orb orb-1" style="width:400px; height:400px; top: 10%; right: 10%; opacity: 0.4;"></div>
    </div>

    <main class="table">
      <section class="table__header">
        <h1><i class='bx bx-face-recognition'></i> Face Verification</h1>
      </section>

      <section class="table__body">
        <div id="cameraSection" style="display:block;">
          <video id="localVideo" class="host-img" autoplay playsinline muted style="filter: brightness(1) contrast(1);"></video>
          <canvas id="captureCanvas" style="display:none;"></canvas>
        </div>
        
        <div id="brightnessControls" style="margin-top:15px; padding:15px; background:#222; border-radius:8px; display:none;">
          <div style="color:#fff; margin-bottom:12px;">
            <label style="display:block; margin-bottom:8px;">
              <i class='bx bx-sun'></i> Brightness: <span id="brightnessValue">100</span>%
            </label>
            <input type="range" id="brightness" min="50" max="150" value="100" style="width:100%; cursor:pointer;">
          </div>
          <div style="color:#fff;">
            <label style="display:block; margin-bottom:8px;">
              <i class='bx bx-adjust'></i> Contrast: <span id="contrastValue">100</span>%
            </label>
            <input type="range" id="contrast" min="50" max="150" value="100" style="width:100%; cursor:pointer;">
          </div>
        </div>
        
        <div id="cameraControls" style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label for="deviceSelect" style="color:#fff;">Camera:</label>
          <select id="deviceSelect" style="min-width:220px; padding:6px; border-radius:6px;"></select>
          <button id="retryBtn" class="next" style="padding:6px 12px;">Retry</button>
          <button id="brightnessToggle" class="next" style="padding:6px 12px; display:none;">
            <i class='bx bx-sun'></i> Adjust Light
          </button>
        </div>

        <div id="uploadSection" style="margin-top:20px; padding:20px; border:2px dashed #666; border-radius:8px; text-align:center; display:none;">
          <p style="color:#fff; margin-bottom:10px;"><strong>Camera unavailable?</strong> Upload a photo instead:</p>
          <input type="file" id="photoUpload" accept="image/*" style="padding:8px; color:#fff;">
          <button id="uploadBtn" class="next" style="margin-top:10px; padding:8px 16px;">Upload Photo</button>
        </div>
      </section>

      <p class="table__text">
        <i class='bx bx-info-circle'></i> Please ensure your face is clearly visible and centered within the frame
        before capturing.
      </p>

      <button id="captureBtn" class="next" disabled style="opacity: 0.6;">
        Capture & Save <i class='bx bx-camera'></i>
      </button>

      <script>
        const video = document.getElementById('localVideo');
        const canvas = document.getElementById('captureCanvas');
        const btn = document.getElementById('captureBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const photoUpload = document.getElementById('photoUpload');
        const brightnessSlider = document.getElementById('brightness');
        const contrastSlider = document.getElementById('contrast');
        const brightnessValue = document.getElementById('brightnessValue');
        const contrastValue = document.getElementById('contrastValue');
        const brightnessToggle = document.getElementById('brightnessToggle');
        const brightnessControls = document.getElementById('brightnessControls');
        let cameraAvailable = false;

        // Brightness and Contrast Control
        function updateFilter() {
          const brightness = brightnessSlider.value / 100;
          const contrast = contrastSlider.value / 100;
          video.style.filter = `brightness(${brightness}) contrast(${contrast})`;
          brightnessValue.textContent = brightnessSlider.value;
          contrastValue.textContent = contrastSlider.value;
        }

        brightnessSlider.addEventListener('input', updateFilter);
        contrastSlider.addEventListener('input', updateFilter);

        brightnessToggle.addEventListener('click', function (e) {
          e.preventDefault();
          brightnessControls.style.display = brightnessControls.style.display === 'none' ? 'block' : 'none';
          brightnessToggle.textContent = brightnessControls.style.display === 'none' ? '☀️ Adjust Light' : '✓ Light OK';
        });

        async function tryGetUserMedia(constraints) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            return stream;
          } catch (e) {
            throw e;
          }
        }

        async function waitForVideoReady(videoElement, timeout = 5000) {
          return new Promise((resolve, reject) => {
            const startTime = Date.now();
            
            const checkReady = () => {
              if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                resolve();
              } else if (Date.now() - startTime > timeout) {
                reject(new Error('Video element did not become ready in time'));
              } else {
                requestAnimationFrame(checkReady);
              }
            };
            
            if (videoElement.srcObject) {
              checkReady();
            } else {
              reject(new Error('Video source not set'));
            }
          });
        }

        async function initCamera() {
          try {
            await populateDeviceList();
            const selected = document.getElementById('deviceSelect').value;
            await startStream(selected || null);
            cameraAvailable = true;
            btn.disabled = false;
            btn.style.opacity = '1';
            brightnessToggle.style.display = 'block';
            brightnessControls.style.display = 'block';
            console.log('Camera initialized successfully');
          } catch (err) {
            console.error('initCamera error:', err.message || err);
            cameraAvailable = false;
            btn.disabled = true;
            btn.style.opacity = '0.6';
            brightnessToggle.style.display = 'none';
            brightnessControls.style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            const msg = `Camera unavailable: ${err && err.message ? err.message : err}.\n\nOptions:\n1. Select a different camera from the dropdown and click Retry\n2. Upload a photo instead\n3. Close Zoom, Teams, or other camera apps and refresh`;
            alert(msg);
          }
        }

        async function populateDeviceList() {
          const sel = document.getElementById('deviceSelect');
          sel.innerHTML = '';
          try {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const cams = devices.filter(d => d.kind === 'videoinput');
            console.log('Found cameras:', cams.length);
            
            if (cams.length === 0) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.text = 'No camera found';
              sel.appendChild(opt);
              return;
            }
            
            cams.forEach((dev, idx) => {
              const opt = document.createElement('option');
              opt.value = dev.deviceId;
              opt.text = (dev.label && dev.label.trim()) ? dev.label : `Camera ${idx + 1}`;
              sel.appendChild(opt);
            });
          } catch (e) {
            console.error('populateDeviceList failed:', e);
            const opt = document.createElement('option');
            opt.value = '';
            opt.text = 'Unable to list cameras';
            sel.appendChild(opt);
          }
        }

        async function startStream(deviceId) {
          try {
            // Stop any existing tracks first
            if (video.srcObject) {
              video.srcObject.getTracks().forEach(t => {
                try {
                  t.stop();
                } catch (e) {
                  console.warn('Error stopping track:', e);
                }
              });
              video.srcObject = null;
            }
            
            // Wait for tracks to fully release
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Request camera
            const constraints = deviceId 
              ? { 
                  video: { 
                    deviceId: { exact: deviceId }, 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 } 
                  }, 
                  audio: false 
                } 
              : { 
                  video: { 
                    width: { ideal: 1280 }, 
                    height: { ideal: 720 } 
                  }, 
                  audio: false 
                };
            
            console.log('Requesting camera with constraints:', constraints);
            const stream = await tryGetUserMedia(constraints);
            video.srcObject = stream;
            
            // Wait for video to load metadata
            await waitForVideoReady(video);
            
            console.log('Stream started successfully. Video dimensions:', video.videoWidth, 'x', video.videoHeight);
            cameraAvailable = true;
            btn.disabled = false;
            btn.style.opacity = '1';
            brightnessToggle.style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
          } catch (e) {
            console.error('startStream failed:', e.message || e);
            cameraAvailable = false;
            btn.disabled = true;
            btn.style.opacity = '0.6';
            brightnessToggle.style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            throw e;
          }
        }

        btn.addEventListener('click', async function (e) {
          e.preventDefault();
          if (!cameraAvailable || !video.srcObject) {
            alert('Camera not initialized. Please upload a photo or select another camera.');
            return;
          }
          
          if (video.videoWidth === 0 || video.videoHeight === 0) {
            alert('Camera is not ready. Please wait a moment and try again.');
            return;
          }
          
          try {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Apply filter to canvas as well
            const brightness = brightnessSlider.value / 100;
            const contrast = contrastSlider.value / 100;
            ctx.filter = `brightness(${brightness}) contrast(${contrast})`;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataURL = canvas.toDataURL('image/jpeg', 0.85);
            
            btn.disabled = true;
            btn.textContent = 'Uploading...';
            
            const res = await fetch('{{ url_for('saveFaceInput') }}', {
              method: 'POST',
              credentials: 'same-origin',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image: dataURL })
            });
            
            const j = await res.json();
            if (j.success) {
              window.location.href = '{{ url_for('confirmFaceInput') }}';
            } else {
              alert(j.error || 'Failed to save image');
              btn.disabled = false;
              btn.textContent = 'Capture & Save';
            }
          } catch (err) {
            console.error('Error capturing/uploading:', err);
            alert('Error: ' + (err.message || err));
            btn.disabled = false;
            btn.textContent = 'Capture & Save';
          }
        });

        uploadBtn.addEventListener('click', async function (e) {
          e.preventDefault();
          const file = photoUpload.files[0];
          if (!file) {
            alert('Please select a photo');
            return;
          }
          
          try {
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            const reader = new FileReader();
            reader.onerror = function() {
              alert('Error reading file. Please try again.');
              uploadBtn.disabled = false;
              uploadBtn.textContent = 'Upload Photo';
            };
            reader.onload = async function (ev) {
              const dataURL = ev.target.result;
              try {
                const res = await fetch('{{ url_for('saveFaceInput') }}', {
                  method: 'POST',
                  credentials: 'same-origin',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ image: dataURL })
                });
                const j = await res.json();
                if (j.success) {
                  window.location.href = '{{ url_for('confirmFaceInput') }}';
                } else {
                  alert(j.error || 'Failed to save image');
                  uploadBtn.disabled = false;
                  uploadBtn.textContent = 'Upload Photo';
                }
              } catch (err) {
                console.error('Error uploading:', err);
                alert('Upload failed: ' + (err.message || err));
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Photo';
              }
            };
            reader.readAsDataURL(file);
          } catch (err) {
            console.error('Error preparing upload:', err);
            alert('Error: ' + (err.message || err));
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload Photo';
          }
        });

        document.getElementById('retryBtn').addEventListener('click', async function (ev) {
          ev.preventDefault();
          const sel = document.getElementById('deviceSelect');
          const deviceId = sel.value || null;
          try {
            await startStream(deviceId);
            console.log('Retry successful');
          } catch (e) {
            console.error('Retry failed:', e);
            alert('Retry failed: ' + (e && e.message ? e.message : e) + '\n\nTry uploading a photo instead.');
          }
        });

        // Initialize camera when page loads
        window.addEventListener('load', initCamera);
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
          if (video.srcObject) {
            video.srcObject.getTracks().forEach(t => {
              try {
                t.stop();
              } catch (e) {
                console.warn('Error stopping track on unload:', e);
              }
            });
          }
        });
      </script>
    </main>
  </div>

  <footer>
    <p>&copy; 2024 The Online Exam Proctor System. All rights reserved.</p>
  </footer>

</body>

</html>