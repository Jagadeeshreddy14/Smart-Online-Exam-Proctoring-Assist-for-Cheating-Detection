<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Compatibility Check</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="{{url_for('static', filename='css/style.css')}}">
    <link rel="stylesheet" href="{{url_for('static', filename='css/SystemCheck.css')}}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

    <nav>
        <div class="logo">
            <span class="P-title">The Online Exam Proctor</span>
        </div>
        <div class="nav-links">
            <a class="links" href="#">Rules</a>
            <a class="links" href="#">Requirements</a>
        </div>
    </nav>

    <!-- Background Orbs -->
    <div
        style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; overflow:hidden; pointer-events:none;">
        <div class="bg-orb orb-1" style="top: 20%; left: 10%; opacity: 0.3; width: 300px; height: 300px;"></div>
        <div class="bg-orb orb-2" style="bottom: 20%; right: 10%; opacity: 0.3; width: 300px; height: 300px;"></div>
    </div>

    <main class="table">
        <section class="table__header">
            <h1><i class='bx bx-devices'></i> System Check</h1>
        </section>

        <section class="table__body">
            <table>
                <thead>
                    <tr>
                        <th>Component</th>
                        <th style="text-align: right;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <i class='bx bxs-camera' style="margin-right: 8px; color: var(--primary);"></i> Webcam
                        </td>
                        <td><span id="webcam-status" style="color: var(--text-muted);">Checking...</span></td>
                    </tr>
                    <tr>
                        <td>
                            <i class='bx bxs-microphone' style="margin-right: 8px; color: var(--secondary);"></i>
                            Microphone
                        </td>
                        <td><span id="microphone-status" style="color: var(--text-muted);">Checking...</span></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="section-button">
            <a href="#" class="next" id="ajax-link">
                Continue to Exam <i class='bx bx-right-arrow-alt'></i>
            </a>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 The Online Exam Proctor System</p>
    </footer>

    <script>
        async function checkWebcamAndMicrophone() {
            const webcamStatusElement = document.getElementById('webcam-status');
            const microphoneStatusElement = document.getElementById('microphone-status');

            console.log("Starting hardware compatibility check...");

            // Check Webcam
            try {
                const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcamStatusElement.textContent = 'Available';
                webcamStatusElement.style.color = '#4ade80';
                console.log("Webcam access: SUCCESS");
                videoStream.getTracks().forEach(track => track.stop());
            } catch (error) {
                console.error("Webcam access: FAILED", error);
                webcamStatusElement.textContent = 'Not available';
                webcamStatusElement.style.color = '#f87171';
            }

            // Check Microphone
            try {
                const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphoneStatusElement.textContent = 'Available';
                microphoneStatusElement.style.color = '#4ade80';
                console.log("Microphone access: SUCCESS");
                audioStream.getTracks().forEach(track => track.stop());
            } catch (error) {
                console.error("Microphone access: FAILED", error);
                microphoneStatusElement.textContent = 'Not available';
                microphoneStatusElement.style.color = '#f87171';
            }
        }

        checkWebcamAndMicrophone();

        $(document).ready(function () {
            $("#ajax-link").click(function (event) {
                event.preventDefault();

                const checkValue1 = document.getElementById('webcam-status').textContent;
                const checkValue2 = document.getElementById('microphone-status').textContent;

                // Simple check before sending
                if (checkValue1 !== 'Available' || checkValue2 !== 'Available') {
                    // Start simple alert, maybe use custom modal later
                    // console.warn("System checks failed");
                }

                $.ajax({
                    url: "/systemCheck",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ input: checkValue1 + ';' + checkValue2 }),
                    success: function (response) {
                        window.location.href = "/" + response['output'];
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX request failed:", error);
                    }
                });
            });
        });
    </script>
</body>

</html>